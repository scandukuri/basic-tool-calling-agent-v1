# Simplified Tool-Calling Agent

A streamlined agent implementation that integrates with an external Platform for session management and message history tracking.

## Architecture Overview

```
┌─────────┐
│Frontend │ (generates session_id, displays messages)
└────┬────┘
     │
     ▼
┌─────────┐
│ Agent   │ (no local session storage)
└────┬────┘
     │
     ├─── GET  → Platform (fetch config + history)
     ├─── POST → Platform (save results + trace)
     └─── Return → Frontend (stream response)
```

## Key Simplifications

1. **No Local Session Storage** - Agent doesn't track sessions or messages
2. **Platform is Source of Truth** - All session data stored in Platform
3. **Session ID Generated by Agent** - Frontend creates session_id on "New Chat"
4. **Frontend Displays History** - Messages shown locally until "End Session"
5. **Simultaneous Operations** - Stream to frontend AND POST to Platform

## Flow

### 1. User Starts New Chat
```
Frontend generates session_id (e.g., "sess_abc123")
```

### 2. User Sends Message
```
Frontend → Agent: POST /chat
{
    "session_id": "sess_abc123",
    "message": "What is 2+2?"
}

Agent:
  ├─ GET {PLATFORM_URL}/api/sessions/{session_id}
  │  Returns: {config: {...}, messages: [...]}
  │
  ├─ Run agent scaffolding with config + messages
  │  (tool calling, OpenAI API, etc.)
  │
  ├─ POST {PLATFORM_URL}/api/sessions/{session_id}
  │  Sends: {session_id, messages, trace, timestamp}
  │
  └─ Return response to frontend
     {"response": "...", "session_id": "...", "trace_id": "..."}

Frontend displays response
```

### 3. User Continues Conversation
```
Same flow - Agent GETs full history from Platform each time
```

### 4. User Ends Session
```
Frontend clears local messages
Session data remains in Platform database
```

## API Endpoints

### Agent Endpoints

#### `POST /chat`
Main chat endpoint that handles all Platform integration.

**Request:**
```json
{
    "session_id": "sess_abc123",
    "message": "What is 2+2?"
}
```

**Response:**
```json
{
    "response": "The result is 4.",
    "session_id": "sess_abc123"
}
```

#### `GET /`
Embedded web UI for testing.

### Expected Platform Endpoints

**The Platform must implement 2 endpoints:**
1. **GET** `/api/sessions/{session_id}` - Return config + message history
2. **POST** `/api/sessions/{session_id}` - Save conversation + trace data

Details:

#### `GET /api/sessions/{session_id}`
Returns config + message history for a session.

**Response:**
```json
{
    "config": {
        "system_prompt": "You are a helpful assistant...",
        "temperature": 0.7,
        "top_p": 1.0,
        "max_tokens": 2048
    },
    "messages": [
        {"role": "user", "content": "Hello"},
        {"role": "assistant", "content": "Hi there!"}
    ]
}
```

**Status Codes:**
- `200` - Session found, returns config + messages
- `404` - New session, agent uses defaults

#### `POST /api/sessions/{session_id}`
Saves session results and trace data.

**Request:**
```json
{
    "session_id": "sess_abc123",
    "messages": [
        {"role": "user", "content": "What is 2+2?"},
        {"role": "assistant", "content": "The result is 4."}
    ],
    "trace": {
        "trace_id": "trace_xyz",
        "started_at": "2025-10-18T20:00:00",
        "completed_at": "2025-10-18T20:00:03",
        "tool_calls": [...],
        "turns": [...],
        "config": {...},
        "total_tokens": 150
    },
    "timestamp": "2025-10-18T20:00:03"
}
```

## Setup

1. **Install dependencies:**
```bash
python -m venv venv
source venv/bin/activate  # or `venv\Scripts\activate` on Windows
pip install -r requirements.txt
```

2. **Set environment variables:**
```bash
export OPENAI_API_KEY=your-api-key-here
export PLATFORM_URL=http://localhost:8000  # Your Platform URL
```

3. **Run the agent:**
```bash
python app.py
```

4. **Open browser:**
```
http://localhost:5000
```

## Testing Without Platform

The agent includes fallback behavior if Platform is unavailable:
- Returns default config on GET failures
- Logs warning on POST failures
- Agent continues to function for testing

To test standalone:
```bash
# Platform is unavailable - agent uses defaults
OPENAI_API_KEY=sk-... python app.py
```

## Environment Variables

- `OPENAI_API_KEY` (required) - OpenAI API key
- `PLATFORM_URL` (optional) - Platform base URL (default: http://localhost:8000)

## Available Tools

1. **web_search** - Search the web using DuckDuckGo
2. **calculator** - Evaluate math expressions safely

## Trace Data

Every agent execution generates comprehensive trace data:

```json
{
    "trace_id": "trace_xyz",
    "started_at": "ISO timestamp",
    "completed_at": "ISO timestamp",
    "total_tokens": 150,
    "config": {
        "model": "gpt-4o",
        "temperature": 0.7,
        "top_p": 1.0,
        "max_tokens": 2048
    },
    "tool_calls": [
        {
            "name": "calculator",
            "arguments": {"expression": "2+2"},
            "result": "4",
            "duration_ms": 0.5,
            "timestamp": "..."
        }
    ],
    "turns": [
        {"role": "user", "content": "...", "timestamp": "..."},
        {"role": "assistant", "content": "...", "timestamp": "..."}
    ]
}
```

This trace data is:
- POSTed to Platform for storage
- Returned to frontend with trace_id
- Suitable for A/B testing analysis

## Multi-Turn Support

Multi-turn conversations are fully supported:

1. Platform maintains full message history
2. Agent GETs complete history on each turn
3. Agent appends new turn to history
4. Agent POSTs updated history back to Platform
5. Frontend displays all messages until "End Session"

## What Changed from Original

**Removed:**
- `sessions = {}` dictionary
- `/session/start` endpoint
- `/session/end` endpoint
- `/session/<id>` endpoint
- `/v1/chat/completions` endpoint
- `/traces` endpoints
- Local session tracking logic

**Added:**
- `get_platform_session()` - GET from Platform
- `post_platform_session()` - POST to Platform
- `PLATFORM_URL` environment variable
- Simplified `/chat` endpoint with Platform integration
- Frontend session_id generation

**Kept:**
- Tool calling scaffolding (_run_completion)
- Tool definitions (web_search, calculator)
- Embedded web UI
- Trace generation
- Multi-turn support

## File Size Comparison

- **Before:** 814 lines (app.py)
- **After:** 734 lines (app.py)
- **Reduction:** 80 lines (~10%)

## Benefits

1. **Simpler Architecture** - No dual storage, Platform is single source of truth
2. **Stateless Agent** - Easier to scale horizontally
3. **Clear Separation** - Agent handles execution, Platform handles persistence
4. **Multi-Turn Ready** - Platform manages conversation history
5. **Test-Friendly** - Fallback behavior when Platform unavailable
# basic-tool-calling-agent-v1
